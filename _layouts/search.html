---
layout: default
nodate: true
permalink: "{{site.search.url}}"
---
<script defer src="/js/lunr-{{site.cacheVersioning.script}}.js"></script>
<script>
  const SEARCH_RESULTS_ID = "search-results";
  const SEARCH_QUERY_ID = "search-query";
  const SEARCH_SUBMIT_ID = "search-submit";

  var searchIndex,
    friendlyMap;

  function getParameterByName(name, url) {
    url = url
      ? url
      : location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    let regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
    let results = regex.exec(url);
    if (! results) {
      return null;
    }
    if (! results[2]) {
      return "";
    }
    return decodeURIComponent(results[2].replace(/\+/g, " "));
  }

  function removeChildren(parent) {
    if (parent) {
      let child = parent.lastElementChild;
      while (child) {
        parent.removeChild(child);
        child = parent.lastElementChild;
      }
    }
  }

  function printResultEntry(parent, entry) {
    if (parent) {
      let friend = friendlyMap.get(entry.ref);

      let article = document.createElement("article");
      parent.appendChild(article);
      if (friend.title && friend.title != "notitle") {
        let title = document.createElement("h2");
        title.classList = "mt-ryt mb-0";
        article.appendChild(title);

        let linkToArticle = document.createElement("a");
        linkToArticle.classList = 'no-underline';
        linkToArticle.href = entry.ref;
        linkToArticle.innerHTML = friend.title;
        title.appendChild(linkToArticle);
      } else {
        let abstract = friend.abstract || friend.excerpt || friend.content;
        abstract = abstract.split(' ').slice(
          0,
          parseInt("{{site.excerptWordCount}}")
            ? parseInt("{{site.excerptWordCount}}")
            : 25
        ).join(" ") + " … ";
        let excerpt = document.createElement("p");
        excerpt.innerHTML = abstract;
        let linkToArticle = document.createElement("a");
        linkToArticle.href = entry.ref;
        linkToArticle.innerHTML = "Read more";
        excerpt.appendChild(linkToArticle);
        article.appendChild(excerpt);
      }

      if (friend.date || (friend.tags.length && ! friend.notags)) {
        let aside = document.createElement("aside");
        aside.classList = `${
          friend.starred
            ? friend.starred
            : ""
          }`;
        article.appendChild(aside);

        if (friend.date) {
          let date = document.createElement("time");
          date.innerHTML += friend.humanDate;
          date.classList = "inline-block mr-ryt";
          date.appendChild(document.createTextNode(" "));
          aside.appendChild(date);
        }

        if (friend.tags.length && ! friend.notags) {
          let tags = document.createElement("span");
          aside.appendChild(tags);

          for (let tag of friend.tags) {
            if (tag.name == "{{site.starTag}}") {
              let tagLink = document.createElement("a");
              tagLink.href = tag.url;
              tagLink.innerHTML = "{{site.starTagSymbol}}";
              tagLink.classList = "no-underline px-ryt-2xs mr-ryt-sm";
              tags.appendChild(tagLink);
              break;
            }
          }
          for (let tag of friend.tags) {
            if (tag.name != "{{site.starTag}}") {
              let tagLink = document.createElement("a");
              tagLink.href = tag.url;
              tagLink.innerHTML = tag.name;
              tagLink.classList = "no-underline inline-block mr-ryt-sm";
              tags.appendChild(tagLink);
            }
          }
        }
      }
    }
  }

  function printHeading(resultSet, query) {
    let heading = document.getElementsByTagName("h1");
    if (heading.length) {
      if (resultSet.length) {
        heading[0].innerHTML = 'Search results for "' + query + '"';
      } else {
        heading[0].innerHTML = 'No search results for "' + query + '"';
      }
    }
  }

  function printResultCount(searchResults, resultSet, query) {
    let count = document.createElement("div");
    if (resultSet.length == 0) {
      count.innerHTML = 'Your search for "' + query + '" did not return any results.';
    } else if (resultSet.length == 1) {
      count.innerHTML = 'One result:';
    } else {
      count.innerHTML = resultSet.length + ' results:';
    } searchResults.append(count);
  }

  function printSearching() {
    let searchResults = document.getElementById(SEARCH_RESULTS_ID);
    if (! searchResults) {
      console.error("The page does not have a DOM element with id=" + SEARCH_RESULTS_ID);
      return;
    }
    removeChildren(searchResults);
    let searching = document.createElement("div");
    searching.innerHTML = "Searching …";
    searchResults.append(searching);
  }

  function printSearchResults(resultSet, query) {
    let searchResults = document.getElementById(SEARCH_RESULTS_ID);
    if (! searchResults) {
      console.error("The page does not have a DOM element with id=" + SEARCH_RESULTS_ID);
      return;
    }
    removeChildren(searchResults);
    printHeading(resultSet, query);
    printResultCount(searchResults, resultSet, query);
    if (resultSet.length) {
      for (let entry of resultSet) {
        printResultEntry(searchResults, entry);
      }
    }
  }

  function search(query) {
    if (searchIndex && friendlyMap) {
      let resultSet = [];
      if (query && query.trim().length) {
        resultSet = searchIndex.search(query);
      }
      printSearchResults(resultSet, query);
    }
  }

  function maintainInputState() {
    let submit = document.getElementById(SEARCH_SUBMIT_ID);
    if (submit) {
      if (lunr && searchIndex && friendlyMap) {
        submit.disabled = false;
      } else {
        submit.disabled = true;
      }
    }
  }

  maintainInputState();
  addEventListener("load", function(event) {
    maintainInputState();
    let query = getParameterByName("query");
    let input = document.getElementById(SEARCH_QUERY_ID);
    if (input) {
      input.value = query;
    }
    if (query) {
      printSearching();
    }
    fetch("/search-index.json", {credentials: "same-origin"})
      .then((response) => {
        return response.json();
      })
      .then((rawIndex) => {
        searchIndex = lunr.Index.load(rawIndex);
        return fetch("/excerpt-index.json", {credentials: "same-origin"});
      })
      .then((response) => {
        return response.json();
      })
      .then((excerptIndex) => {
        friendlyMap = new Map();
        for (let item of excerptIndex) {
          friendlyMap.set(item.id, item);
        }
        maintainInputState();

        if (query) {
          search(query);
        }
      })
      .catch((error) => {
        console.error("Failure when creating search index " + error);
      });
  });
</script>
<section class="my-ryt-2xl">
  {% include "search-field.html", focus: true, onsubmit:
   "event.preventDefault(); search(event.target[SEARCH_QUERY_ID].value);
   history.replaceState(null, '', location.pathname + '?query=' +
   event.target[SEARCH_QUERY_ID].value)" %}
</section>
<div id="search-results"></div>